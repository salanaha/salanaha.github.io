<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5345115650647198"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج جداول الحراسة من إعداد الأستاذ حاجي صلاح الدين</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: #f5f7fa; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { background: linear-gradient(135deg, #1e3a8a, #2563eb); color: white; padding: 30px; border-radius: 10px; text-align: center; margin-bottom: 30px; }
        h1 { font-size: 2rem; margin-bottom: 10px; }
        .subtitle { opacity: 0.9; }
        .status-bar { display: flex; gap: 15px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        .status-badge { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; }
        .quick-nav { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .quick-nav button { padding: 12px 20px; border: none; border-radius: 8px; background: white; border: 2px solid #e0e7ff; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .quick-nav button:hover { background: #e0e7ff; border-color: #2563eb; }
        .quick-nav button.active { background: #2563eb; color: white; border-color: #2563eb; }
        .app-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-top: 5px solid #2563eb; }
        .card h2 { color: #1e3a8a; margin-bottom: 20px; border-bottom: 2px solid #e0e7ff; padding-bottom: 12px; display: flex; align-items: center; gap: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
        input, select, textarea { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: 0.3s; }
        input:focus, select:focus { border-color: #2563eb; outline: none; }
        .btn { padding: 14px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-info { background: #06b6d4; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .actions { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .table-container { overflow-x: auto; margin-top: 20px; border: 1px solid #e5e7eb; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #1e3a8a; color: white; padding: 15px; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center; }
        tr:hover { background: #f9fafb; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 25px 0; }
        .stat-card { background: linear-gradient(135deg, white, #f8fafc); padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; border-left: 4px solid #2563eb; }
        .stat-value { font-size: 2.5rem; font-weight: 800; color: #1e3a8a; }
        .stat-label { color: #6b7280; }
        .empty-state { text-align: center; padding: 50px; color: #9ca3af; }
        .empty-state i { font-size: 4rem; margin-bottom: 15px; }
        .alert { background:#f0f9ff; padding:15px; border-radius:8px; margin-bottom:20px; border-left: 4px solid #2563eb; }
        .file-upload { border:2px dashed #d1d5db; padding:40px; text-align:center; border-radius:12px; cursor:pointer; margin-top:20px; }
        .tabs { display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; }
        .tab { padding: 12px 20px; cursor: pointer; background: #f1f5f9; border-bottom: 3px solid transparent; }
        .tab.active { background: white; border-bottom-color: #2563eb; font-weight: 600; color: #2563eb; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .professor-tag { display: inline-block; background: #e0e7ff; color: #1e3a8a; padding: 6px 12px; border-radius: 20px; margin: 3px; font-size: 0.9rem; cursor: grab; }
        .professor-tag:active { cursor: grabbing; }
        .professor-list { min-height: 40px; }
        .blue-background-class { background-color: #dbeafe; }
        .subject-badge { display: inline-block; background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 20px; margin: 2px; font-size: 0.8rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 25px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header button { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        @media (max-width: 768px) { .app-grid, .stats-grid { grid-template-columns: 1fr; } }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body>
<div class="container">
    <header>
        <h1><i class="fas fa-user-shield"></i> برنامج جداول الحراسة المتكامل</h1>
        <p class="subtitle">نظام عادل لإدارة وتوزيع حراسات الامتحانات - تدوير القاعات + احتياط عادل + خوارزمية عادلة</p>
        <div class="status-bar">
            <span class="status-badge"><i class="fas fa-save"></i> <span id="saveStatus">الحفظ التلقائي مفعل</span></span>
            <span class="status-badge"><i class="fas fa-database"></i> <span id="dataCount">0 أستاذ، 0 قاعة</span></span>
        </div>
    </header>  <div class="quick-nav">
    <button onclick="showSection('import', this)" class="active"><i class="fas fa-users"></i> الأساتذة</button>
    <button onclick="showSection('rooms', this)"><i class="fas fa-door-closed"></i> القاعات</button>
    <button onclick="showSection('exams', this)"><i class="fas fa-calendar-alt"></i> الامتحانات</button>
    <button onclick="showSection('distribution', this)"><i class="fas fa-cogs"></i> إعداد الجدول</button>
    <button onclick="showSection('results', this)"><i class="fas fa-chart-bar"></i> عرض الجداول</button>
</div>

<div id="importSection" class="app-grid">
    <div class="card">
        <h2><i class="fas fa-users"></i> إدارة الأساتذة</h2>
        <div class="alert"><i class="fas fa-info-circle"></i> يمكنك استيراد قائمة الأساتذة من ملف Excel أو إضافتهم يدوياً.</div>
        <div class="actions" style="justify-content: center;">
            <button class="btn-info" onclick="downloadTeacherTemplate()"><i class="fas fa-download"></i> تنزيل نموذج الأساتذة</button>
        </div>
        <div class="file-upload" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-file-excel" style="font-size:3rem; color:#2563eb;"></i>
            <h3>انقر لاختيار ملف الأساتذة</h3>
            <p id="fileStatus">لم يتم اختيار ملف بعد</p>
        </div>
        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none;" onchange="handleFileUpload(event)">
        <div class="actions">
            <button class="btn-success" onclick="showAddTeacherModal()"><i class="fas fa-user-plus"></i> إضافة أستاذ يدوي</button>
            <button class="btn-primary" onclick="exportTeachers()"><i class="fas fa-file-export"></i> تصدير القائمة</button>
        </div>
    </div>
    <div class="card">
        <h2><i class="fas fa-chalkboard-teacher"></i> قائمة الأساتذة</h2>
        <div class="form-group">
            <input type="text" id="teacherSearch" placeholder="بحث عن أستاذ..." onkeyup="filterTeachers()">
        </div>
        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
            <table>
                <thead><tr><th>الاسم</th><th>المادة</th><th>الحالة</th><th>الإجراءات</th></tr></thead>
                <tbody id="teachersTable"></tbody>
            </table>
        </div>
        <div class="actions">
            <button class="btn-danger" onclick="clearAllTeachers()"><i class="fas fa-trash"></i> مسح كل الأساتذة</button>
        </div>
    </div>
</div>

<div id="roomsSection" style="display:none;">
    <div class="card">
        <h2><i class="fas fa-door-closed"></i> إدارة قاعات الامتحان</h2>
        <div class="alert"><i class="fas fa-info-circle"></i> أضف هنا <strong>الحد الأقصى</strong> المتاح من القاعات في مؤسستك (مثلاً 20). سيتم استخدام العدد المطلوب فقط في كل فترة.</div>
        <div class="form-group">
            <label>عدد القاعات الأقصى</label>
            <input type="number" id="roomCount" min="1" value="15" placeholder="أدخل عدد القاعات">
        </div>
        <button class="btn-success" onclick="generateRooms()"><i class="fas fa-plus"></i> إنشاء القاعات</button>
        <div class="table-container">
            <table>
                <thead><tr><th>#</th><th>اسم القاعة</th><th>الإجراءات</th></tr></thead>
                <tbody id="roomsTable"></tbody>
            </table>
        </div>
        <div class="actions">
            <button class="btn-danger" onclick="clearAllRooms()"><i class="fas fa-trash"></i> حذف الكل</button>
        </div>
    </div>
</div>

<div id="examsSection" style="display:none;">
    <div class="card">
        <h2><i class="fas fa-calendar-alt"></i> جدول سير الامتحانات</h2>
        <div class="tabs">
            <div class="tab active" onclick="showExamTab('manualAdd', this)">إضافة يدوية</div>
            <div class="tab" onclick="showExamTab('importFile', this)">استيراد من ملف</div>
        </div>

        <div id="manualAddTab" class="tab-content active" style="padding-top: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group"><label>التاريخ</label><input type="date" id="examDate"></div>
                <div class="form-group"><label>الفترة</label><select id="examPeriod"><option value="صباح">صباح</option><option value="مساء">مساء</option></select></div>
            </div>
            <div class="form-group">
                <label>عدد القاعات المطلوبة لهذه الفترة <span style="color:red">*</span></label>
                <input type="number" id="examRoomCount" min="1" value="14" placeholder="كم قاعة تحتاج؟">
            </div>
            <div class="form-group"><label>المواد (افصل بينها بفاصلة)</label><input type="text" id="examSubjects" placeholder="مثال: رياضيات, فيزياء, عربية"></div>
            <button class="btn-success" onclick="addExamDay()"><i class="fas fa-plus"></i> إضافة يوم</button>
        </div>

        <div id="importFileTab" class="tab-content" style="padding-top: 20px;">
            <div class="alert"><i class="fas fa-info-circle"></i> استورد ملف Excel يحتوي على أعمدة: <strong>التاريخ</strong>، <strong>الفترة</strong>، <strong>المواد</strong>، <strong>عدد القاعات</strong>.</div>
            <div class="actions" style="justify-content: center; margin-bottom: 20px;">
                <button class="btn-info" onclick="downloadExamTemplate()"><i class="fas fa-download"></i> تنزيل نموذج الامتحانات</button>
            </div>
            <div class="file-upload" onclick="document.getElementById('examFileInput').click()">
                <i class="fas fa-file-excel" style="font-size:3rem; color:#10b981;"></i>
                <h3>انقر لاختيار ملف جدول الامتحانات</h3>
                <p id="examFileStatus">لم يتم اختيار ملف بعد</p>
            </div>
            <input type="file" id="examFileInput" accept=".csv,.xlsx,.xls" style="display:none;" onchange="handleExamFileUpload(event)">
        </div>

        <div class="table-container" style="margin-top: 30px;">
            <table>
                <thead><tr><th>#</th><th>التاريخ</th><th>الفترة</th><th>المواد</th><th>القاعات المطلوبة</th><th>الإجراءات</th></tr></thead>
                <tbody id="examsTable"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="distributionSection" style="display:none;">
    <div class="card">
        <h2><i class="fas fa-cogs"></i> إعداد جدول الحراسة</h2>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value" id="totalTeachersStat">0</div><div class="stat-label">أستاذ نشط</div></div>
            <div class="stat-card"><div class="stat-value" id="totalRoomsStat">0</div><div class="stat-label">قاعة متاحة كحد أقصى</div></div>
            <div class="stat-card"><div class="stat-value" id="totalExamsStat">0</div><div class="stat-label">فترة امتحان</div></div>
        </div>
        <div class="form-group">
            <label>عدد الحراس لكل قاعة</label>
            <select id="teachersPerRoom"><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option></select>
        </div>
        <div class="form-group">
            <label>عدد الأساتذة الاحتياط لكل فترة</label>
            <input type="number" id="reserveCount" min="0" value="2" placeholder="عدد الاحتياط">
        </div>
        <div class="form-group">
            <label>الحد الأقصى للحراسات لكل أستاذ (0 يعني غير محدود)</label>
            <input type="number" id="maxAssignmentsPerTeacher" min="0" value="0" placeholder="أدخل الحد الأقصى">
        </div>
        <div class="actions">
            <button class="btn-success" onclick="generateSchedule()"><i class="fas fa-cogs"></i> توليد الجدول العادل</button>
            <button class="btn-primary" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير الجدول العام</button>
            <button class="btn-warning" onclick="printSchedule()"><i class="fas fa-print"></i> طباعة الجدول العام</button>
            <button class="btn-info" onclick="printAllIndividualSchedules()"><i class="fas fa-print"></i> طباعة كل الجداول الفردية</button>
        </div>
    </div>
</div>

<div id="resultsSection" style="display:none;">
    <div class="card">
        <h2><i class="fas fa-table"></i> عرض الجداول</h2>
        <div class="tabs">
            <div class="tab active" onclick="showResultTab('schedule', this)">الجدول العام (تفاعلي)</div>
            <div class="tab" onclick="showResultTab('teachers', this)">توزيع الحصص على الأساتذة</div>
            <div class="tab" onclick="showResultTab('reserves', this)">الأساتذة الاحتياط</div>
        </div>
        <div class="tab-content active" id="scheduleTab">
            <div class="alert"><i class="fas fa-hand-pointer"></i> يمكنك سحب وإفلات أسماء الأساتذة بين القاعات في نفس الفترة لتعديل الجدول يدوياً.</div>
            <div id="scheduleOutput" class="empty-state"><i class="fas fa-calendar-plus"></i><p>لم يتم توليد جدول بعد</p></div>
        </div>
        <div class="tab-content" id="teachersTab">
            <div id="teachersOutput" class="empty-state"><i class="fas fa-users"></i><p>لا توجد بيانات</p></div>
        </div>
        <div class="tab-content" id="reservesTab">
            <div id="reservesOutput" class="empty-state"><i class="fas fa-user-clock"></i><p>سيظهر هنا الأساتذة الاحتياط بعد توليد الجدول.</p></div>
        </div>
    </div>
</div>

</div>  <div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3 id="modalTitle"></h3><button onclick="closeModal()"><i class="fas fa-times"></i></button></div>
        <div id="modalBody"></div>
        <div class="modal-footer"><button class="btn-danger" onclick="closeModal()">إلغاء</button><button class="btn-success" onclick="confirmModal()">تأكيد</button></div>
    </div>
</div>  <script>
// =============== البيانات الرئيسية ===============
let teachers = [];
let rooms = [];
let examDays = [];
let schedule = [];
let reserves = [];

// =============== تهيئة ===============
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    document.getElementById('examDate').value = today.toISOString().split('T')[0];
    loadFromStorage();
    updateAllSections();
    showSection('import', document.querySelector('.quick-nav button'));
});

// =============== الحفظ في LocalStorage ===============
function saveToStorage() {
    // تحويل Set إلى Array قبل الحفظ
    const teachersToSave = teachers.map(t => {
        const teacherData = { ...t };
        if (teacherData.guardedRooms instanceof Set) {
            teacherData.guardedRooms = Array.from(teacherData.guardedRooms);
        }
        return teacherData;
    });

    const data = { teachers: teachersToSave, rooms, examDays, schedule, reserves };
    localStorage.setItem('supervisionData', JSON.stringify(data));
    document.getElementById('saveStatus').innerHTML = 'تم الحفظ';
    setTimeout(() => document.getElementById('saveStatus').innerHTML = 'الحفظ التلقائي مفعل', 2000);
}

function loadFromStorage() {
    const saved = localStorage.getItem('supervisionData');
    if (saved) {
        try {
            const data = JSON.parse(saved);
            teachers = data.teachers || [];
            rooms = data.rooms || [];
            examDays = data.examDays || [];
            schedule = data.schedule || [];
            reserves = data.reserves || [];

            // تحويل Array المحفوظ إلى Set بعد التحميل
            teachers.forEach(t => {
                t.guardedRooms = new Set(t.guardedRooms || []);
                t.totalAssigned = t.totalAssigned || 0;
                t.totalReserves = t.totalReserves || 0;
                t.assignments = t.assignments || [];
                t.exemptions = t.exemptions || [];
                t.lastAssignedDate = t.lastAssignedDate || null;
                t.lastAssignedPeriod = t.lastAssignedPeriod || null;
            });
        } catch(e) { console.error("خطأ في تحميل البيانات:", e); }
    }
}

// =============== التنقل بين الأقسام ===============
function showSection(section, element) {
    document.querySelectorAll('.quick-nav button').forEach(btn => btn.classList.remove('active'));
    element.classList.add('active');
    ['import', 'rooms', 'exams', 'distribution', 'results'].forEach(id => {
        const el = document.getElementById(id + 'Section');
        if (el) el.style.display = 'none';
    });
    document.getElementById(section + 'Section').style.display = section === 'import' ? 'grid' : 'block';
    updateAllSections();
}

// =============== دوال الأساتذة ===============
function downloadTeacherTemplate() {
    const data = [
        ['الاسم الكامل', 'المادة المدرسة', 'الحالة'],
        ['أحمد محمد', 'الرياضيات', 'نشط'],
        ['فاطمة الزهراء', 'الفيزياء', 'نشط'],
        ['علي محمود', 'اللغة العربية', 'معفى']
    ];
    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [{ wch: 20 }, { wch: 20 }, { wch: 15 }];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'نموذج الأساتذة');
    XLSX.writeFile(wb, 'نموذج_الأساتذة.xlsx');
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    document.getElementById('fileStatus').innerText = 'جاري المعالجة...';
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            const startRow = (rows[0] && rows[0][0] && rows[0][0].toLowerCase().includes('اسم')) ? 1 : 0;
            let importedCount = 0;
            for (let i = startRow; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[0]) continue;
                const name = String(row[0]).trim();
                const subject = String(row[1] || 'غير محدد').trim();
                const statusRaw = String(row[2] || 'نشط').trim().toLowerCase();
                const statusMap = { 'نشط': 'active', 'معفى': 'exempt', 'إدارة': 'admin' };
                const status = statusMap[statusRaw] || 'active';
                if (name && !teachers.some(t => t.name === name)) {
                    teachers.push({
                        id: Date.now() + i,
                        name: name,
                        subject: subject,
                        status: status,
                        exempt: (status === 'exempt' || status === 'admin'),
                        assignments: [],
                        guardedRooms: new Set(),
                        exemptions: [],
                        totalAssigned: 0,
                        totalReserves: 0,
                        lastAssignedDate: null,
                        lastAssignedPeriod: null
                    });
                    importedCount++;
                }
            }
            document.getElementById('fileStatus').innerHTML = `تم استيراد ${importedCount} أستاذ`;
            saveToStorage();
            updateTeachersTable();
            alert(`تم استيراد ${importedCount} أستاذ بنجاح.`);
        } catch(err) {
            alert('خطأ في قراءة الملف. تأكد من صيغته.');
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
}

function exportTeachers() {
    if (!teachers.length) return alert('لا يوجد بيانات لتصديرها.');
    const statusMap = { 'active': 'نشط', 'exempt': 'معفى', 'admin': 'إدارة' };
    const data = [['الاسم الكامل', 'المادة المدرسة', 'الحالة']];
    teachers.forEach(t => data.push([t.name, t.subject, statusMap[t.status]]));
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'قائمة الأساتذة');
    XLSX.writeFile(wb, 'قائمة_الأساتذة.xlsx');
}

function updateTeachersTable() {
    const tbody = document.getElementById('teachersTable');
    tbody.innerHTML = '';
    if (!teachers.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">لا يوجد أساتذة</td></tr>';
        return;
    }
    const statusMap = { 'active': 'نشط', 'exempt': 'معفى', 'admin': 'إدارة' };
    teachers.forEach((t, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${t.name}</td>
            <td>${t.subject}</td>
            <td><span class="status-badge" style="background: #eee; color: #333;">${statusMap[t.status] || 'نشط'}</span></td>
            <td>
                <button class="btn-warning btn-sm" onclick="editTeacher(${i})"><i class="fas fa-edit"></i></button>
                <button class="btn-danger btn-sm" onclick="deleteTeacher(${i})"><i class="fas fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    updateStats();
}

function showAddTeacherModal() {
    document.getElementById('modalTitle').innerText = 'إضافة أستاذ جديد';
    document.getElementById('modalBody').innerHTML = `
        <div class="form-group"><label>الاسم الكامل</label><input type="text" id="modalTeacherName"></div>
        <div class="form-group"><label>المادة المدرسة</label><input type="text" id="modalTeacherSubject"></div>
        <div class="form-group"><label>الحالة</label><select id="modalTeacherStatus">
            <option value="active">نشط (يحرس)</option><option value="exempt">معفى (لا يحرس)</option><option value="admin">إدارة</option>
        </select></div>`;
    document.getElementById('modal').style.display = 'flex';
    window.modalCallback = function() {
        const name = document.getElementById('modalTeacherName').value.trim();
        if (!name) return alert('الرجاء إدخال الاسم');
        const status = document.getElementById('modalTeacherStatus').value;
        teachers.push({
            id: Date.now(),
            name: name,
            subject: document.getElementById('modalTeacherSubject').value.trim() || 'غير محدد',
            status: status,
            exempt: (status === 'exempt' || status === 'admin'),
            assignments: [],
            guardedRooms: new Set(),
            exemptions: [],
            totalAssigned: 0,
            totalReserves: 0,
            lastAssignedDate: null,
            lastAssignedPeriod: null
        });
        closeModal();
        updateTeachersTable();
        saveToStorage();
    };
}

function editTeacher(index) {
    const t = teachers[index];
    if (!t.exemptions) t.exemptions = [];

    document.getElementById('modalTitle').innerText = 'تعديل بيانات أستاذ';
    
    let exemptionsHtml = t.exemptions.map((ex, i) => `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px; background: #f1f5f9; padding: 5px; border-radius: 5px;">
            <span>إعفاء في: <strong>${ex.date}</strong> (${ex.period === 'all' ? 'يوم كامل' : ex.period})</span>
            <button class="btn-danger btn-sm" style="margin-right: auto;" onclick="removeExemption(${index},
${i})">X</button>
        </div>
    `).join('');

    document.getElementById('modalBody').innerHTML = `
        <div class="form-group"><label>الاسم الكامل</label><input type="text" id="modalTeacherName" value="${t.name}"></div>
        <div class="form-group"><label>المادة المدرسة</label><input type="text" id="modalTeacherSubject" value="${t.subject}"></div>
        <div class="form-group"><label>الحالة العامة</label><select id="modalTeacherStatus">
            <option value="active" ${t.status === 'active' ? 'selected' : ''}>نشط (يحرس)</option>
            <option value="exempt" ${t.status === 'exempt' ? 'selected' : ''}>معفى (بشكل دائم)</option>
            <option value="admin" ${t.status === 'admin' ? 'selected' : ''}>إدارة</option>
        </select></div>
        <hr style="margin: 20px 0;">
        <h4><i class="fas fa-calendar-times"></i> الإعفاءات المخصصة</h4>
        <div id="exemptionsList" style="margin-bottom: 15px;">${exemptionsHtml || '<p style="color: #9ca3af;">لا توجد إعفاءات مخصصة.</p>'}</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: end;">
            <div class="form-group">
                <label>تاريخ الإعفاء</label>
                <input type="date" id="exemptionDate">
            </div>
            <div class="form-group">
                <label>فترة الإعفاء</label>
                <select id="exemptionPeriod">
                    <option value="all">يوم كامل</option>
                    <option value="صباح">فترة الصباح</option>
                    <option value="مساء">فترة المساء</option>
                </select>
            </div>
        </div>
        <button class="btn-info" onclick="addExemption(${index})"><i class="fas fa-plus"></i> إضافة إعفاء</button>
    `;
    document.getElementById('modal').style.display = 'flex';

    window.modalCallback = function() {
        t.name = document.getElementById('modalTeacherName').value.trim();
        t.subject = document.getElementById('modalTeacherSubject').value.trim();
        t.status = document.getElementById('modalTeacherStatus').value;
        t.exempt = (t.status === 'exempt' || t.status === 'admin');
        closeModal();
        updateTeachersTable();
        saveToStorage();
    };
}

function deleteTeacher(index) {
    if (confirm(`هل أنت متأكد من حذف الأستاذ: ${teachers[index].name}؟`)) {
        teachers.splice(index, 1);
        updateTeachersTable();
        saveToStorage();
    }
}

function filterTeachers() {
    const term = document.getElementById('teacherSearch').value.toLowerCase();
    document.querySelectorAll('#teachersTable tr').forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
    });
}

function clearAllTeachers() {
    if (confirm('تحذير: سيتم حذف جميع الأساتذة بشكل نهائي. هل أنت متأكد؟')) {
        teachers = [];
        updateTeachersTable();
        saveToStorage();
    }
}

function addExemption(teacherIndex) {
    const teacher = teachers[teacherIndex];
    const date = document.getElementById('exemptionDate').value;
    const period = document.getElementById('exemptionPeriod').value;

    if (!date) return alert('الرجاء تحديد تاريخ للإعفاء.');
    if (!teacher.exemptions) teacher.exemptions = [];

    const exists = teacher.exemptions.some(ex => ex.date === date && ex.period === period);
    if (exists) return alert('هذا الإعفاء موجود بالفعل.');

    teacher.exemptions.push({ date, period });
    saveToStorage();
    editTeacher(teacherIndex);
}

function removeExemption(teacherIndex, exemptionIndex) {
    teachers[teacherIndex].exemptions.splice(exemptionIndex, 1);
    saveToStorage();
    editTeacher(teacherIndex);
}

// =============== إدارة القاعات ===============
function generateRooms() {
    const count = parseInt(document.getElementById('roomCount').value);
    if (isNaN(count) || count < 1) return alert('الرجاء إدخال عدد صحيح أكبر من 0');
    rooms = Array.from({ length: count }, (_, i) => ({ id: Date.now() + i, name: `قاعة ${i + 1}` }));
    updateRoomsTable();
    saveToStorage();
    alert(`تم إنشاء ${count} قاعة كحد أقصى متاح.`);
}

function updateRoomsTable() {
    const tbody = document.getElementById('roomsTable');
    tbody.innerHTML = !rooms.length ? '<tr><td colspan="3" class="empty-state">لا توجد قاعات</td></tr>' :
        rooms.map((r, i) => `<tr>
            <td>${i + 1}</td>
            <td><input type="text" value="${r.name}" onchange="updateRoomName(${i}, this.value)" style="width:100%; padding:5px; text-align:center; border: 1px solid #ddd; border-radius: 5px;"></td>
            <td><button class="btn-danger btn-sm" onclick="deleteRoom(${i})"><i class="fas fa-trash"></i></button></td>
        </tr>`).join('');
}

function updateRoomName(index, newName) {
    if (!newName.trim()) {
        alert('اسم القاعة لا يمكن أن يكون فارغاً');
        updateRoomsTable(); return;
    }
    rooms[index].name = newName.trim();
    saveToStorage();
}

function deleteRoom(index) {
    if (confirm('هل أنت متأكد من حذف هذه القاعة؟')) {
        rooms.splice(index, 1);
        updateRoomsTable();
        saveToStorage();
    }
}

function clearAllRooms() {
    if (confirm('تحذير: سيتم حذف جميع القاعات. هل أنت متأكد؟')) {
        rooms = [];
        updateRoomsTable();
        saveToStorage();
    }
}

// =============== إدارة الامتحانات ===============
function showExamTab(tabName, element) {
    document.querySelectorAll('#examsSection .tab').forEach(t => t.classList.remove('active'));
    element.classList.add('active');
    document.querySelectorAll('#examsSection .tab-content').forEach(c => c.style.display = 'none');
    document.getElementById(tabName + 'Tab').style.display = 'block';
}

function downloadExamTemplate() {
    const today = new Date();
    const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
    const data = [
        ['التاريخ', 'الفترة', 'المواد', 'عدد القاعات'],
        [today.toISOString().split('T')[0], 'صباح', 'رياضيات, فيزياء', 14],
        [today.toISOString().split('T')[0], 'مساء', 'عربية, تاريخ', 15],
        [tomorrow.toISOString().split('T')[0], 'صباح', 'علوم, لغة إنجليزية', 14]
    ];
    const ws = XLSX.utils.aoa_to_sheet(data);
    ws['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 30 }, { wch: 15 }];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'نموذج جدول الامتحانات');
    XLSX.writeFile(wb, 'نموذج_جدول_الامتحانات.xlsx');
}

function handleExamFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    document.getElementById('examFileStatus').innerText = 'جاري المعالجة...';
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            const startRow = (rows[0] && typeof rows[0][0] === 'string' && rows[0][0].includes('التاريخ')) ? 1 : 0;
            let importedCount = 0;
            examDays = [];
            for (let i = startRow; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[0]) continue;
                let date;
                if (row[0] instanceof Date) {
                    row[0].setMinutes(row[0].getMinutes() + row[0].getTimezoneOffset());
                    date = row[0].toISOString().split('T')[0];
                } else {
                    date = new Date(row[0]).toISOString().split('T')[0];
                }
                const period = String(row[1] || 'صباح').trim();
                const subjectsStr = String(row[2] || '').trim();
                const rCount = parseInt(row[3]) || rooms.length || 14;
                
                if (!subjectsStr) continue;
                const subjects = subjectsStr.split(',').map(s => s.trim()).filter(s => s);
                addExamDay(date, period, subjects, rCount, true);
                importedCount++;
            }
            document.getElementById('examFileStatus').innerHTML = `تم استيراد ${importedCount} فترة اختبار.`;
            saveToStorage();
            updateExamsTable();
            alert(`تم استيراد جدول الامتحانات بنجاح (${importedCount} فترة).`);
        } catch(err) {
            alert('خطأ في قراءة ملف جدول الامتحانات. تأكد من صيغة الملف والتواريخ.');
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
}

function addExamDay(date, period, subjects, rCount, fromImport = false) {
    let roomCount = rCount;
    if (!fromImport) {
        date = document.getElementById('examDate').value;
        period = document.getElementById('examPeriod').value;
        const subjectsStr = document.getElementById('examSubjects').value.trim();
        roomCount = parseInt(document.getElementById('examRoomCount').value) || rooms.length;
        if (!subjectsStr) return alert('الرجاء إدخال المواد الممتحنة.');
        subjects = subjectsStr.split(',').map(s => s.trim()).filter(s => s);
    }
    
    if (!date || !subjects || subjects.length === 0) return alert('الرجاء ملء حقلي التاريخ والمواد.');
    const exists = examDays.some(e => e.date === date && e.period === period);
    if (exists) {
        if (!fromImport) alert('يوجد اختبار في نفس اليوم والفترة.');
        return;
    }
    const dateObj = new Date(date);
    dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
    const days = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
    const dayName = days[dateObj.getDay()];
    examDays.push({
        id: Date.now() + Math.random(),
        date: date,
        displayDate: dayName + ' ' + dateObj.toLocaleDateString('ar-EG'),
        period: period,
        subjects: subjects,
        roomCount: roomCount
    });
    if (!fromImport) {
        updateExamsTable();
        saveToStorage();
    }
}

function updateExamsTable() {
    examDays.sort((a, b) => new Date(a.date) - new Date(b.date) || (a.period === 'صباح' ? -1 : 1));
    const tbody = document.getElementById('examsTable');
    tbody.innerHTML = !examDays.length ? '<tr><td colspan="6" class="empty-state">لا توجد أيام اختبارات</td></tr>' :
        examDays.map((e, i) => `<tr>
            <td>${i + 1}</td>
            <td>${e.displayDate}</td>
            <td>${e.period}</td>
            <td>${e.subjects.map(s => `<span class="subject-badge">${s}</span>`).join(' ')}</td>
            <td><span class="status-badge" style="background: #e0f2fe; color: #0369a1;">${e.roomCount || rooms.length} قاعة</span></td>
            <td><button class="btn-danger btn-sm" onclick="deleteExamDay(${i})"><i class="fas fa-trash"></i></button></td>
        </tr>`).join('');
    updateStats();
}

function deleteExamDay(index) {
    if (confirm('هل أنت متأكد من حذف هذا اليوم؟')) {
        examDays.splice(index, 1);
        updateExamsTable();
        saveToStorage();
    }
}

// =============== *** الدالة المعدلة لتوليد الجدول *** ===============
function generateSchedule() {
    if (!teachers.length) return alert('يرجى إضافة الأساتذة أولاً.');
    if (!rooms.length) return alert('يرجى إضافة الحد الأقصى للقاعات أولاً.');
    if (!examDays.length) return alert('يرجى إضافة جدول الامتحانات أولاً.');

    const activeTeachers = teachers.filter(t => !t.exempt);
    if (!activeTeachers.length) return alert('لا يوجد أساتذة نشطون.');

    const teachersPerRoom = parseInt(document.getElementById('teachersPerRoom').value) || 1;
    const reserveCount = parseInt(document.getElementById('reserveCount').value) || 0;
    const maxAllowed = parseInt(document.getElementById('maxAssignmentsPerTeacher').value) || 0;

    // إعادة تعيين العدادات والمهام
    teachers.forEach(t => {
        t.totalAssigned = 0;
        t.totalReserves = 0;
        t.assignments = [];
        t.guardedRooms = new Set();
        t.lastAssignedDate = null;
        t.lastAssignedPeriod = null;
    });

    schedule = [];
    reserves = [];

    const isTeacherExempted = (teacher, day) => {
        if (!teacher.exemptions) return false;
        return teacher.exemptions.some(ex =>
            ex.date === day.date &&
            (ex.period === 'all' || ex.period === day.period)
        );
    };

    const sortedDays = [...examDays].sort((a, b) => new Date(a.date) - new Date(b.date) || (a.period === 'صباح' ? -1 : 1));

    let assignedInDay = {}; // لتتبع من حرس في كل يوم

    sortedDays.forEach(day => {
        let assignedInPeriod = new Set();
        if (!assignedInDay[day.date]) assignedInDay[day.date] = new Set();

        // ==================== توزيع الاحتياط أولاً (مع أولوية للمادة) ====================
        let reserveCandidates = activeTeachers.filter(t => !isTeacherExempted(t, day));
        
        // 1. المرشحون ذوو الأولوية (نفس المادة)
        let priorityReserve = reserveCandidates.filter(t => day.subjects.includes(t.subject));
        
        // 2. المرشحون العاديون (بقية المواد)
        let normalReserve = reserveCandidates.filter(t => !day.subjects.includes(t.subject));

        // دمج القائمتين مع الحفاظ على الأولوية والترتيب حسب عبء العمل
        priorityReserve.sort((a, b) => a.totalAssigned - b.totalAssigned);
        normalReserve.sort((a, b) => a.totalAssigned - b.totalAssigned);
        
        let finalReserveCandidates = [...priorityReserve, ...normalReserve];

        for (let r = 0; r < reserveCount; r++) {
            let teacher = finalReserveCandidates.find(t => !assignedInPeriod.has(t.id));
            if (!teacher) break; // لا يوجد مرشحون متاحون

            teacher.totalAssigned++;
            teacher.totalReserves++;
            teacher.assignments.push({ date: day.date, period: day.period, room: 'احتياط' });
            teacher.lastAssignedDate = day.date;
            teacher.lastAssignedPeriod = day.period;
            assignedInPeriod.add(teacher.id);
            assignedInDay[day.date].add(teacher.id);

            let reserveGroup = reserves.find(rg => rg.date === day.date && rg.period === day.period);
            if (!reserveGroup) {
                reserveGroup = { date: day.date, period: day.period, teachers: [] };
                reserves.push(reserveGroup);
            }
            reserveGroup.teachers.push({ id: teacher.id, name: teacher.name });
        }

        // ==================== توزيع القاعات (مع أولوية لتجميع العمل) ====================
        const currentRoomCount = day.roomCount || rooms.length;
        const activeRoomsForPeriod = rooms.slice(0, currentRoomCount);

        activeRoomsForPeriod.forEach((room, roomIndex) => {
            let slot = {
                date: day.date,
                displayDate: day.displayDate,
                period: day.period,
                room: room.name,
                subject: day.subjects[roomIndex % day.subjects.length],
                professors: []
            };

            for (let i = 0; i < teachersPerRoom; i++) {
                let baseCandidates = activeTeachers.filter(t => !assignedInPeriod.has(t.id) && !isTeacherExempted(t, day));
                
                // 1. المرشحون ذوو الأولوية (من حرس صباحاً في نفس اليوم)
                let priorityCandidates = [];
                if (day.period === 'مساء') {
                    priorityCandidates = baseCandidates.filter(t => assignedInDay[day.date].has(t.id));
                }

                // 2. المرشحون العاديون (البقية)
                let normalCandidates = baseCandidates.filter(t => !priorityCandidates.some(p => p.id === t.id));

                // دمج القائمتين مع تطبيق الشروط والترتيب
                const filterAndSort = (candidateList) => {
                    return candidateList.filter(t => {
                        const subjectConflict = t.subject.trim().toLowerCase() === slot.subject.trim().toLowerCase();
                        const roomConflict = t.guardedRooms.has(room.name);
                        const maxedOut = maxAllowed > 0 && t.totalAssigned >= maxAllowed;
                        return !subjectConflict && !roomConflict && !maxedOut;
                    }).sort((a, b) => a.totalAssigned - b.totalAssigned);
                };

                let finalCandidates = [...filterAndSort(priorityCandidates), ...filterAndSort(normalCandidates)];

                // نظام طوارئ: إذا لم نجد مرشحين، نتجاوز شرط تدوير القاعة
                if (finalCandidates.length === 0) {
                     const filterAndSortEmergency = (candidateList) => {
                        return candidateList.filter(t => {
                            const subjectConflict = t.subject.trim().toLowerCase() === slot.subject.trim().toLowerCase();
                            const maxedOut = maxAllowed > 0 && t.totalAssigned >= maxAllowed;
                            return !subjectConflict && !maxedOut; // تم إزالة شرط القاعة
                        }).sort((a, b) => a.totalAssigned - b.totalAssigned);
                    };
                    finalCandidates = [...filterAndSortEmergency(priorityCandidates), ...filterAndSortEmergency(normalCandidates)];
                }
                
                // اختيار الأفضل
                let teacher = finalCandidates[0];

                if (!teacher) {
                    slot.professors.push({ name: '--- شاغر ---' });
                    continue;
                }

                // تحديث بيانات الأستاذ
                teacher.totalAssigned++;
                teacher.assignments.push({ date: day.date, period: day.period, room: room.name });
                teacher.guardedRooms.add(room.name);
                teacher.lastAssignedDate = day.date;
                teacher.lastAssignedPeriod = day.period;
                assignedInPeriod.add(teacher.id);
                assignedInDay[day.date].add(teacher.id);

                slot.professors.push({ id: teacher.id, name: teacher.name, subject: teacher.subject });
            }
            schedule.push(slot);
        });
    });

    saveToStorage();
    showSection('results', document.querySelector('.quick-nav button[onclick*="results"]'));
    displayResults();
    alert('تم توليد الجدول بنجاح مع تطبيق الأولويات الجديدة ✅');
}


// =============== عرض النتائج ===============
function displayResults() {
    if (!schedule.length) {
        document.getElementById('scheduleOutput').innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>لم يتم توليد جدول بعد</p></div>';
        document.getElementById('teachersOutput').innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>لا توجد بيانات</p></div>';
        document.getElementById('reservesOutput').innerHTML = '<div class="empty-state"><i class="fas fa-user-clock"></i><p>سيظهر هنا الأساتذة الاحتياط بعد توليد الجدول.</p></div>';
        return;
    }

    const groupedSchedule = schedule.reduce((acc, s) => {
        const key = `${s.date}|${s.period}`;
        if (!acc[key]) acc[key] = { displayDate: s.displayDate, period: s.period, slots: [] };
        acc[key].slots.push(s);
        return acc;
    }, {});

    let html = '';
    Object.values(groupedSchedule).forEach(group => {
        html += `<h3 style="margin-top: 20px; background: #eef2ff; padding: 10px; border-radius: 5px;">${group.displayDate} - ${group.period} (استُخدمت ${group.slots.length} قاعة)</h3>`;
        html += '<div class="table-container"><table><thead><tr><th>القاعة</th><th>المادة</th><th>الأساتذة الحراس</th></tr></thead><tbody>';
        group.slots.forEach(slot => {
            html += `<tr>
                <td>${slot.room}</td>
                <td><span class="subject-badge">${slot.subject}</span></td>
                <td class="professor-list" data-slot-key="${slot.date}|${slot.period}|${slot.room}">
                    ${slot.professors.map(p => `<span class="professor-tag" data-teacher-id="${p.id}">${p.name}</span>`).join(' ')}
                </td>
            </tr>`;
        });
        html += '</tbody></table></div>';
    });
    document.getElementById('scheduleOutput').innerHTML = html;

    const active = teachers.filter(t => !t.exempt);
    active.sort((a,b) => b.totalAssigned - a.totalAssigned);
    let teacherHtml = '<div class="table-container"><table><thead><tr><th>الاسم</th><th>المادة</th><th>عدد الحراسات (مع الاحتياط)</th><th>مرات الاحتياط</th><th>القاعات المحروسة</th><th>طباعة فردي</th></tr></thead><tbody>';
    active.forEach(t => {
        const roomsList = Array.from(t.guardedRooms).join('، ') || 'لا توجد';
        teacherHtml += `<tr><td>${t.name}</td><td>${t.subject}</td><td><strong>${t.totalAssigned}</strong></td><td>${t.totalReserves || 0}</td><td style="font-size: 0.85rem;">${roomsList}</td>
            <td><button class="btn-info btn-sm" onclick="printTeacherSchedule(${t.id})"><i class="fas fa-print"></i></button></td></tr>`;
    });
    teacherHtml += '</tbody></table></div>';
    document.getElementById('teachersOutput').innerHTML = teacherHtml;

    let reserveHtml = '<div class="table-container"><table><thead><tr><th>التاريخ</th><th>الفترة</th><th>الأساتذة الاحتياط</th></tr></thead><tbody>';
    if (reserves.length === 0) {
        reserveHtml = '<div class="empty-state"><i class="fas fa-user-clock"></i><p>لا يوجد أساتذة احتياط.</p></div>';
    } else {
        reserves.sort((a, b) => new Date(a.date) - new Date(b.date));
        reserves.forEach(r => {
            const day = examDays.find(d => d.date === r.date && d.period === r.period);
            const display = day ? day.displayDate : r.date;
            const teachersNames = r.teachers.map(t => t.name).join('، ');
            reserveHtml += `<tr><td>${display}</td><td>${r.period}</td><td>${teachersNames}</td></tr>`;
        });
        reserveHtml += '</tbody></table></div>';
    }
    document.getElementById('reservesOutput').innerHTML = reserveHtml;

    activateDragAndDrop();
}

function showResultTab(tab, element) {
    document.querySelectorAll('#resultsSection .tab').forEach(t => t.classList.remove('active'));
    element.classList.add('active');
    document.querySelectorAll('#resultsSection .tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tab + 'Tab').classList.add('active');
}

function activateDragAndDrop() {
    document.querySelectorAll('.professor-list').forEach(list => {
        new Sortable(list, {
            group: 'professors',
            animation: 150,
            ghostClass: 'blue-background-class',
            onEnd: function (evt) {
                const itemEl = evt.item;
                const fromListEl = evt.from;
                const toListEl = evt.to;
                const teacherId = parseInt(itemEl.getAttribute('data-teacher-id'));
                const fromSlotKey = fromListEl.getAttribute('data-slot-key');
                const toSlotKey = toListEl.getAttribute('data-slot-key');
                if (fromSlotKey === toSlotKey) return;
                
                const fromKeyParts = fromSlotKey.split('|');
                const toKeyParts = toSlotKey.split('|');
                const fromDate = fromKeyParts[0];
                const fromPeriod = fromKeyParts[1];
                const toDate = toKeyParts[0];
                const toPeriod = toKeyParts[1];

                if (fromDate !== toDate || fromPeriod !== toPeriod) {
                    alert('لا يمكن نقل أستاذ بين فترات أو أيام مختلفة.');
                    fromListEl.appendChild(itemEl);
                    return;
                }
                
                const movedTeacher = teachers.find(t => t.id === teacherId);
                const fromSlot = schedule.find(s => `${s.date}|${s.period}|${s.room}` === fromSlotKey);
                const toSlot = schedule.find(s => `${s.date}|${s.period}|${s.room}` === toSlotKey);

                if (movedTeacher.subject.trim().toLowerCase() === toSlot.subject.trim().toLowerCase()) {
                    alert(`لا يمكن نقل الأستاذ ${movedTeacher.name} إلى حراسة مادة "${toSlot.subject}" لأنه يدرسها.`);
                    fromListEl.appendChild(itemEl);
                    return;
                }
                if (movedTeacher.guardedRooms.has(toSlot.room)) {
                    alert(`لا يمكن نقل الأستاذ ${movedTeacher.name} إلى قاعة "${toSlot.room}" لأنه حرسها مسبقاً.`);
                    fromListEl.appendChild(itemEl);
                    return;
                }

                const profIndex = fromSlot.professors.findIndex(p => p.id === teacherId);
                if (profIndex > -1) fromSlot.professors.splice(profIndex, 1);
                toSlot.professors.push({ id: movedTeacher.id, name: movedTeacher.name, subject: movedTeacher.subject });

                const assignment = movedTeacher.assignments.find(a => a.date === fromSlot.date && a.period === fromSlot.period && a.room === fromSlot.room);
                if (assignment) {
                    movedTeacher.guardedRooms.delete(fromSlot.room);
                    movedTeacher.guardedRooms.add(toSlot.room);
                    assignment.room = toSlot.room;
                }

                saveToStorage();
                displayResults();
            }
        });
    });
}

// =============== طباعة وتصدير ===============
function exportToExcel() {
    if (!schedule.length) return alert('لا يوجد جدول لتصديره.');
    const data = [['التاريخ', 'الفترة', 'القاعة', 'المادة', 'الأساتذة الحراس']];
    schedule.forEach(s => {
        data.push([s.displayDate, s.period, s.room, s.subject, s.professors.map(p=>p.name).join('، ')]);
    });
    if (reserves.length > 0) {
        data.push([]);
        data.push(['الأساتذة الاحتياط']);
        data.push(['التاريخ', 'الفترة', 'الأساتذة']);
        reserves.forEach(r => {
            const day = examDays.find(d => d.date === r.date && d.period === r.period);
            const display = day ? day.displayDate : r.date;
            data.push([display, r.period, r.teachers.map(t => t.name).join('، ')]);
        });
    }
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'جدول الحراسة العام');
    XLSX.writeFile(wb, 'جدول_الحراسة_العام.xlsx');
}

function printSchedule() {
    if (!schedule.length) return alert('لا يوجد جدول لطباعته.');
    const win = window.open('', '_blank');
    win.document.write(`<html><head><title>جدول الحراسة العام</title><style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; direction: rtl; } 
        table { width:100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border:1px solid #333; padding:8px; text-align:center; } 
        th { background: #eee; } 
        h1, h2 { text-align:center; }
    </style></head><body><h1>جدول الحراسة العام</h1>`);  win.document.write('<h2>توزيع الحراسات على القاعات</h2>');
win.document.write('<table><thead><tr><th>التاريخ</th><th>الفترة</th><th>القاعة</th><th>المادة</th><th>الأساتذة الحراس</th></tr></thead><tbody>');
schedule.forEach(s => {
    win.document.write(`<tr><td>${s.displayDate}</td><td>${s.period}</td><td>${s.room}</td><td>${s.subject}</td><td>${s.professors.map(p=>p.name).join('، ')}</td></tr>`);
});
win.document.write('</tbody></table>');
if (reserves.length > 0) {
    win.document.write('<h2>الأساتذة الاحتياط</h2>');
    win.document.write('<table><thead><tr><th>التاريخ</th><th>الفترة</th><th>الأساتذة</th></tr></thead><tbody>');
    reserves.forEach(r => {
        const day = examDays.find(d => d.date === r.date && d.period === r.period);
        const display = day ? day.displayDate : r.date;
        win.document.write(`<tr><td>${display}</td><td>${r.period}</td><td>${r.teachers.map(t => t.name).join('، ')}</td></tr>`);
    });
    win.document.write('</tbody></table>');
}
win.document.write('</body></html>');
win.document.close();
win.print();
}

function printTeacherSchedule(teacherId) {
    const teacher = teachers.find(t => t.id === teacherId);
    if (!teacher || !teacher.assignments || teacher.assignments.length === 0) return alert('لا توجد حراسات لهذا الأستاذ.');
    const win = window.open('', '_blank');
    win.document.write(`<html><head><title>جدول حراسة فردي - ${teacher.name}</title><style> body { font-family: 'Segoe UI', Tahoma, sans-serif; direction: rtl; padding: 20px; }  h1, h2 { text-align: center; } table { width:100%; border-collapse: collapse; margin-top: 20px; }  th, td { border:1px solid #333; padding:8px; text-align:center; } </style></head><body><h1>استدعاء للحراسة</h1><h2>الأستاذ(ة): ${teacher.name}</h2> <p>يشرفنا أن نعلمكم بتعيينكم في حراسة الامتحانات وفق الجدول التالي:</p> <table><thead><tr><th>التاريخ</th><th>الفترة</th><th>
القاعة</th></tr></thead><tbody>`);
    teacher.assignments.sort((a, b) => new Date(a.date) - new Date(b.date) || (a.period === 'صباح' ? -1 : 1)).forEach(a => {
        const day = examDays.find(d => d.date === a.date && d.period === a.period);
        win.document.write(`<tr><td>${day ? day.displayDate : a.date}</td><td>${a.period}</td><td>${a.room === 'احتياط' ? '<b>احتياط</b>' : a.room}</td></tr>`);
    });
    win.document.write('</tbody></table><br><p style="text-align:left; margin-top: 30px;">إمضاء المدير</p></body></html>');
    win.document.close();
    win.print();
}

function printAllIndividualSchedules() {
    const assignedTeachers = teachers.filter(t => t.assignments && t.assignments.length > 0);
    if (assignedTeachers.length === 0) return alert('لا يوجد أساتذة لديهم حراسات لطباعتها.');
    const win = window.open('', '_blank');
    win.document.write(`<html><head><title>جميع جداول الحراسة الفردية</title><style>
       body { font-family: 'Segoe UI', Tahoma, sans-serif; direction: rtl; } 
       .page { page-break-after: always; padding: 20px; height: 95vh; display: flex; flex-direction: column; }
       h1, h2 { text-align: center; } 
       table { width:100%; border-collapse: collapse; margin-top: 20px; }
       th, td { border:1px solid #333; padding:8px; text-align:center; }
       .signature { margin-top: auto; text-align: left; padding-top: 40px;}
   </style></head><body>`);
    assignedTeachers.forEach(teacher => {
        win.document.write(`<div class="page"><h1>استدعاء للحراسة</h1><h2>الأستاذ(ة): ${teacher.name}</h2>
        <p>يشرفنا أن نعلمكم بتعيينكم في حراسة الامتحانات وفق الجدول التالي:</p>
        <table><thead><tr><th>التاريخ</th><th>الفترة</th><th>القاعة</th></tr></thead><tbody>`);
        teacher.assignments.sort((a, b) => new Date(a.date) - new Date(b.date) || (a.period === 'صباح' ? -1 : 1)).forEach(a => {
            const day = examDays.find(d => d.date === a.date && d.period === a.period);
            win.document.write(`<tr><td>${day ? day.displayDate : a.date}</td><td>${a.period}</td><td>${a.room === 'احتياط' ? '<b>احتياط</b>' : a.room}</td></tr>`);
        });
        win.document.write('</tbody></table><div class="signature"><p>إمضاء المدير</p></div></div>');
    });
    win.document.write('</body></html>');
    win.document.close();
    win.print();
}

// =============== أدوات مساعدة ===============
function updateStats() {
    const activeTeachersCount = teachers.filter(t => !t.exempt).length;
    document.getElementById('totalTeachersStat').innerText = activeTeachersCount;
    document.getElementById('totalRoomsStat').innerText = rooms.length;
    document.getElementById('totalExamsStat').innerText = examDays.length;
    document.getElementById('dataCount').innerText = `${teachers.length} أستاذ، ${rooms.length} قاعة قصوى`;
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }
function confirmModal() { if (window.modalCallback) window.modalCallback(); closeModal(); }
function updateAllSections() { updateTeachersTable(); updateRoomsTable(); updateExamsTable(); updateStats(); displayResults(); }

</script>
</body>
</html>
